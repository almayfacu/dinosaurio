<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dinoalma 23</title>
  <style>
    html, body { margin: 0; padding: 0; overflow: hidden; background: #FDECEC; font-family: 'Comic Sans MS'; }
    #game-container { position: relative; width: 100vw; height: 100vh; }
    canvas { display: block; background: #FFF0F5; }
    #hud { position: absolute; top: 10px; left: 10px; color: #333;}
    #hud div { margin: 5px 0; }
    #message { position: absolute; bottom: 20px; width: 100%; text-align: center; font-size: 24px; color: #D9534F; }
    .btn { display: inline-block; margin-top: 15px; padding: 10px 20px; font-family: 'Comic Sans MS'; color: white; font-size: 18px; background: #FFD1DC; border: none; border-radius: 8px; cursor: pointer;}
    #win-overlay { position: absolute; top:0; left:0; width:100%; height:100%; display:none; align-items:center; justify-content:center; flex-direction:column; background: rgba(255,255,255,0.8); }
    #win-overlay img { max-width: 80%; max-height: 80%; border: 4px solid #FFD1DC; border-radius: 12px; }
  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="game"></canvas>
    <div id="hud">
      <div>Tiempo: <span id="time">0.0</span> s</div>
      <div>Obstáculos restantes: <span id="remaining">23</span></div>
    </div>
    <div id="message"></div>
    <div id="win-overlay">
      <img id="winImage" src="tu risa.png" alt="Felicidades">
      <button class="btn" id="restartWin">Volver a jugar</button>
    </div>
    <button class="btn" id="restartLose" style="display:none; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);">Reintentar</button>
    <audio id="jumpSound" src="salto.mp3"></audio>
    <audio id="winSound" src="win.mp3"></audio>
    <audio id="loseSound" src="die.mp3"></audio>
  </div>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    let width, height;

    function resize() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    const avatarImg = new Image();
    avatarImg.src = 'alma.png'; // Asegúrate de tener esta imagen

    const player = {
      x: 100, y: 0, w: 90, h: 90,
      vy: 0, gravity: 0.8, jumpForce: -15, grounded: false,
      hitbox: { offsetX: 20, offsetY: 10, width: 50, height: 70 } // Más pequeño que la imagen
    };

    let obstacles = [];
    const OBSTACLES_TO_WIN = 23;
    let remaining = OBSTACLES_TO_WIN;
    const speed = 6;
    let spawnTimer = 0;
    let nextSpawn = 0;

    let startTime = null;
    let gameState = 'playing';

    const jumpSound = document.getElementById('jumpSound');
    const winSound = document.getElementById('winSound');
    const loseSound = document.getElementById('loseSound');

    function randomSpawnInterval() {
      return Math.floor(Math.random() * 80) + 60;
    }

    function randomObstacleHeight() {
      return Math.floor(Math.random() * 30) + 50; // Altura entre 50 y 80 px
    }

    function startGame() {
      obstacles = [];
      remaining = OBSTACLES_TO_WIN;
      spawnTimer = 0;
      nextSpawn = randomSpawnInterval();
      document.getElementById('remaining').textContent = remaining;
      startTime = performance.now();
      gameState = 'playing';
      player.y = height - 80 - player.h;
      player.vy = 0;
      player.grounded = true;
      document.getElementById('message').textContent = '';
      document.getElementById('restartLose').style.display = 'none';
      document.getElementById('win-overlay').style.display = 'none';
      requestAnimationFrame(update);
    }

    function gameOver(win = false) {
      gameState = 'ended';
      if (win) {
        winSound.play();
        document.getElementById('win-overlay').style.display = 'flex';
      } else {
        loseSound.play();
        document.getElementById('message').textContent = 'Perdiste :(';  
        document.getElementById('restartLose').style.display = 'block';
      }
    }

    function spawnObstacle() {
      const w = 30;
      const h = randomObstacleHeight();
      obstacles.push({ x: width, y: height - 80 - h, w, h, counted: false });
    }

    function update(ts) {
      if (gameState !== 'playing') return;

      ctx.clearRect(0, 0, width, height);

      const elapsed = (ts - startTime) / 1000;
      document.getElementById('time').textContent = elapsed.toFixed(1);

      // Suelo
      ctx.fillStyle = '#E0C097';
      ctx.fillRect(0, height - 80, width, 80);
      ctx.strokeStyle = '#CDA47E';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(0, height - 80);
      ctx.lineTo(width, height - 80);
      ctx.stroke();

      // Física jugador
      player.vy += player.gravity;
      player.y += player.vy;
      if (player.y >= height - 80 - player.h) {
        player.y = height - 80 - player.h;
        player.vy = 0;
        player.grounded = true;
      }

      // Spawn obstáculos
      spawnTimer++;
      if (spawnTimer > nextSpawn) {
        spawnObstacle();
        spawnTimer = 0;
        nextSpawn = randomSpawnInterval();
      }

      obstacles.forEach(o => o.x -= speed);
      obstacles = obstacles.filter(o => o.x + o.w > 0);

      // Colisiones con hitbox precisa
      const px = player.x + player.hitbox.offsetX;
      const py = player.y + player.hitbox.offsetY;
      const pw = player.hitbox.width;
      const ph = player.hitbox.height;

      obstacles.forEach(o => {
        if (px < o.x + o.w && px + pw > o.x && py < o.y + o.h && py + ph > o.y) {
          gameOver(false);
        }
        if (!o.counted && o.x + o.w < player.x) {
          o.counted = true;
          remaining--;
          document.getElementById('remaining').textContent = remaining;
          if (remaining <= 0) gameOver(true);
        }
      });

      // Dibujar jugador
      ctx.drawImage(avatarImg, player.x, player.y, player.w, player.h);

      // Dibujar obstáculos
      obstacles.forEach(o => drawCactus(o.x, o.y, o.w, o.h));

      requestAnimationFrame(update);
    }

    function drawCactus(x, y, w, h) {
      ctx.fillStyle = '#7CB342';
      ctx.fillRect(x + w * 0.3, y, w * 0.4, h);
      ctx.fillRect(x, y + h * 0.3, w * 0.3, w * 0.2);
      ctx.fillRect(x + w * 0.7, y + h * 0.2, w * 0.3, w * 0.2);
      ctx.strokeStyle = '#558B2F';
      ctx.lineWidth = 2;
      ctx.strokeRect(x + w * 0.3, y, w * 0.4, h);
      ctx.strokeRect(x, y + h * 0.3, w * 0.3, w * 0.2);
      ctx.strokeRect(x + w * 0.7, y + h * 0.2, w * 0.3, w * 0.2);
    }

    function jump() {
      if (player.grounded && gameState === 'playing') {
        player.vy = player.jumpForce;
        player.grounded = false;
        jumpSound.play();
      }
    }

    window.addEventListener('keydown', e => { if (e.code === 'Space') jump(); });
    window.addEventListener('touchstart', jump);
    document.getElementById('restartLose').onclick = startGame;
    document.getElementById('restartWin').onclick = startGame;

    startGame();
  </script>
</body>
</html>

